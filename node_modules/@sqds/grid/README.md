# Grid SDK

A unified TypeScript SDK for integrating Grid smart accounts into React applications.

## Installation

```bash
npm install @sqds/grid
# or
yarn add @sqds/grid
```

## Grid Client Setup

```typescript
import { GridClient } from "@sqds/grid";

const gridClient = new GridClient({
  environment: "sandbox",
  apiKey: <GRID_API_KEY>, // API key is optional in case you need the client in the front-end (e.g. for signing)
  baseUrl: <BASE_URL>
});
```

## Quickstart: Noop Transaction

### 1. Setup Utility Functions

```typescript
import * as fs from "fs";
import * as path from "path";

const STATE_DIR = path.join(process.cwd(), ".auth-state");

// Simple helper to pull your api key from a .env file
export function getGridApiKey(): string {
  const apiKey = process.env.GRID_API_KEY;
  if (!apiKey) {
    throw new Error(
      "GRID_API_KEY environment variable is not set. " +
        "Please set it using: export GRID_API_KEY=your_api_key"
    );
  }
  return apiKey;
}

interface StateStorage {
  [key: string]: any;
}

// A series of helpers to store and manage auth state of your grid account
export class LocalState {
  private static ensureStateDir(): void {
    if (!fs.existsSync(STATE_DIR)) {
      fs.mkdirSync(STATE_DIR, { recursive: true });
    }
  }

  private static getFilePath(key: string): string {
    this.ensureStateDir();
    return path.join(STATE_DIR, `${key}.json`);
  }

  static saveState(key: string, data: any): void {
    try {
      const filePath = this.getFilePath(key);
      fs.writeFileSync(filePath, JSON.stringify(data, null, 2));
    } catch (error) {
      console.error(`Failed to save state for key "${key}":`, error);
      throw error;
    }
  }

  static loadState<T = any>(key: string): T | null {
    try {
      const filePath = this.getFilePath(key);
      if (!fs.existsSync(filePath)) {
        return null;
      }
      const data = fs.readFileSync(filePath, "utf8");
      return JSON.parse(data) as T;
    } catch (error) {
      console.error(`Failed to load state for key "${key}":`, error);
      return null;
    }
  }

  static hasState(key: string): boolean {
    const filePath = this.getFilePath(key);
    return fs.existsSync(filePath);
  }

  static clearState(key?: string): void {
    try {
      if (key) {
        const filePath = this.getFilePath(key);
        if (fs.existsSync(filePath)) {
          fs.unlinkSync(filePath);
        }
      } else {
        if (fs.existsSync(STATE_DIR)) {
          const files = fs.readdirSync(STATE_DIR);
          files.forEach((file) => {
            fs.unlinkSync(path.join(STATE_DIR, file));
          });
        }
      }
    } catch (error) {
      console.error(
        `Failed to clear state${key ? ` for key "${key}"` : ""}:`,
        error
      );
      throw error;
    }
  }

  static getAllKeys(): string[] {
    try {
      this.ensureStateDir();
      return fs
        .readdirSync(STATE_DIR)
        .filter((file) => file.endsWith(".json"))
        .map((file) => file.replace(".json", ""));
    } catch (error) {
      console.error("Failed to get all state keys:", error);
      return [];
    }
  }

  static getStateSize(key: string): number {
    try {
      const filePath = this.getFilePath(key);
      if (!fs.existsSync(filePath)) {
        return 0;
      }
      return fs.statSync(filePath).size;
    } catch (error) {
      console.error(`Failed to get state size for key "${key}":`, error);
      return 0;
    }
  }
}
```

### 2. Create a Grid Account & Send Transaction

#### a. Initiate Creation

```typescript
import { GridClient } from "@sqds/grid";

async function createAccount() {
  const gridClient = new GridClient({
    environment: "sandbox",
    apiKey: getGridApiKey(),
    baseUrl: "https://grid.squads.xyz",
  });

  const user = await gridClient.createAccount({
    email: "<YOUR_EMAIL>",
  });

  const context = gridClient.getContext();

  LocalState.saveState("context", context);
  LocalState.saveState("user", user);
}

if (require.main === module) {
  createAccount().catch(console.error);
}
```

### b. Complete Creation & Send Noop Transaction

```typescript
import { GridClient, PrepareArbitraryTransactionRequest } from "@sqds/grid";
import {
  TransactionMessage,
  Keypair,
  Connection,
  Transaction,
  SystemProgram,
  PublicKey,
  VersionedTransaction,
  LAMPORTS_PER_SOL,
  TransactionInstruction,
} from "@solana/web3.js";

async function verifyAccountAndSendTransaction() {
  const context = LocalState.loadState("context");
  const user = LocalState.loadState("user");

  // Recreate GridClient instance from saved context configuration
  const gridClient = new GridClient({
    environment: context.client.environment,
    apiKey: context.client.config.apiKey,
    baseUrl: "https://grid.squads.xyz",
  });

  const sessionSecrets = await gridClient.generateSessionSecrets();

  // Build OTP Payload
  const payload = {
    user: user,
    otpCode: `<YOUR EMAIL OTP CODE>`,
    sessionSecrets,
  };

  // Complete authentication & account creation
  const resp = await gridClient.completeAuthAndCreateAccount(payload);
  const accountData = resp;

  // Build the Noop Instruction
  const noopProgramId = new PublicKey(
    "noopb9bkMVfRPU8AsbpTUg8AQkHtKwMYZiFUjNRtMmV"
  );

  const ix = new TransactionInstruction({
    programId: noopProgramId,
    keys: [],
    data: Buffer.alloc(0),
  });

  const connection = new Connection("https://api.devnet.solana.com");
  const { blockhash, lastValidBlockHeight } =
    await connection.getLatestBlockhash("confirmed");

  // Use the grid account public key as a payer
  const saPublicKey = accountData.address;

  const messageV0 = new TransactionMessage({
    payerKey: new PublicKey(saPublicKey),
    recentBlockhash: blockhash,
    instructions: [ix],
  }).compileToV0Message();

  // Create a versioned transaction
  const transaction = new VersionedTransaction(messageV0);

  // Serialize and encode the transaction
  const serializedTransaction = transaction.serialize();
  const encodedTransaction = Buffer.from(serializedTransaction).toString(
    "base64"
  );

  // Generate Request Payload
  const noopTransactionPayload = {
    transaction: encodedTransaction,
  } as PrepareArbitraryTransactionRequest;

  const transactionPayload = await gridClient.prepareArbitraryTransaction(
    accountData.address,
    noopTransactionPayload
  );

  if (!transactionPayload) {
    throw new Error(
      "Failed to create prepare noop txn: " + JSON.stringify(transactionPayload)
    );
  }

  const signature = await gridClient.signAndSend({
    sessionSecrets: sessionSecrets,
    session: accountData.authentication,
    transactionPayload: transactionPayload.data!,
    address: accountData.address,
  });

  console.log("ðŸ¥³ Signature: ", signature);
}

if (require.main === module) {
  verifyAccountAndSendTransaction().catch(console.error);
}
```


## React Native Expo Setup

For React Native Expo you can use this SDK by using the polyfills:

Install dependencies:

```bash
npm i react-native-get-random-values text-encoding buffer @ethersproject/shims
```

Create `entrypoint.js` file:

```javascript
// Import required polyfills first
import 'react-native-get-random-values';
import 'text-encoding';

import { Buffer } from 'buffer';
global.Buffer = Buffer;

import '@ethersproject/shims';

// Then import the expo router
import 'expo-router/entry';
```

Add `entrypoint.js` to `package.json`:

```json
{
  "name": "your-app",
  "main": "entrypoint.js",
  "version": "1.0.0"
}
```


## Core Features

### Create Account / Register

#### With Email

```typescript
import { GridClient } from "@sqds/grid";


const gridClient = new GridClient({environment: "sandbox", apiKey: <GRID_API_KEY>, baseUrl: <API_BASE_URL>});

const user = await gridClient.createAccount({
    email: 'user@example.io'
});
```
### Generate Session Secrets

```typescript
const sessionSecrets = await gridClient.generateSessionSecrets();
```

Output:

```
[
  {
    publicKey: 'MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEeO4soENGrx3ejRgeBO2dbLhhPeX5c9rZl9KXwczUy0N7PFKAL0tHj9JpTqQ0SEN5zaS3OtBgLZia2vINpMmJbA==',
    privateKey: 'MIGHAgEAMBMGByqGSM49AgEGCCqGSM49AwEHBG0wawIBAQQgAZLliZoAbIxI2qvmHmPRHC9MmzmnZ11nlcGoOqoJ5s6hRANCAAR47iygQ0avHd6NGB4E7Z1suGE95flz2tmX0pfBzNTLQ3s8UoAvS0eP0mlOpDRIQ3nNpLc60GAtmJra8g2kyYls',
    provider: 'privy',
    tag: 'primary'
  },
  {
    publicKey: '0225d0c8d7b77cac0df8ad6d3c1d798114347eb8ff8306ba147f55461b7815285d',
    privateKey: '862cd16fd0cc7e0b26a1bbe18a6bf3985b78f71124a681650070931d8190ddb3',
    provider: 'turnkey',
    tag: 'backup'
  },
  {
    publicKey: 'AtZ6PW4hMBriwAmcBw3kuVS91nxn1WHTZqzMhrL9NfF3',
    privateKey: 'pQRc9u87K52Pb1EvhZHw5XKfyK7l8Y4ZNiOTKz72NJqS7hdVyuaeLROFz28jS62Yn4afqyR5mtUUGh6sH9Qzbg==',
    provider: 'solana',
    tag: 'solana'
  },
  {
    publicKey: 'CsEqNuFKauRcK6uTKsdfMsKWPoo6oha8TPhi2qZxHYNh',
    privateKey: 'eABAQmT/HVzooFuKpgD0PmRsk/q+oOx1XvHicnymRJqwTz0o+XWMaso6QW26LS6D/nlGbX4TZbo2UqUnDRcItg==',
    provider: 'passkey',
    tag: 'passkey'
  }
]
```

### Authentication Flow

#### Verify and Create Account (Email Only)

```typescript
const sessionSecrets = await gridClient.generateSessionSecrets();

// save sessionSecrets

const context = gridClient.getContext();

const payload = {
  user: context.user,
  otpCode: "625932",
  sessionSecrets,
};

const result = await gridClient.completeAuthAndCreateAccount(payload);
console.log("user:", result);
```

#### Verify (No Account Creation)

```typescript
const sessionSecrets = await gridClient.generateSessionSecrets();

// save sessionSecrets

const context = gridClient.getContext();

const payload = {
  user: user,
  otpCode: "591977",
  sessionSecrets,
};

const result = await gridClient.completeAuth(payload);

console.log("user: ", result);
```

### Sign Transactions

```javascript
// Step 1: Create spending limit
const spendingLimitPayload = {
    amount: 100000,
    mint: "4zMMC9srt5Ri5X14GAgXhaHii3GnPAEERYPJgZJDncDU",
    spending_limit_signers: ["7kEydiJ9en86ESNpwpZ45khxX8usgjUmWxbSTzkSbXkR"],
    period: "one_time",
    destinations: ["3ciascNndLTBrDQXvs8nzZgWAiaL33tGM6fx3zzM7Fxt"]
} as SpendingLimitRequest;

const spendingLimitResult = await gridClient.createSpendingLimit(user.address, spendingLimitPayload);

// Step 2: Sign transaction
const signature = await gridClient.signAndSend({
    sessionSecrets: keypairs,
    session: user.authentication,
    transactionPayload: spendingLimitResult.data,
    address: accountAddress
})

console.log('signature: ', signature);
```

## API Reference

### Key Methods

- `createAccount(input)` - Initiate creation of a new grid account
- `completeAuthAndCreateAccount(request)` - Complete creation of a new grid account
- `initAuth(request)` - Initialize authentication flow for existing grid account
- `completeAuth(request)` - Complete authentication with OTP for existing grid account
- `sign(request)` - Sign a transaction
- `send(request)` - Submit a signed transaction
- `getContext()` - Get current client context
- `createSpendingLimit(address, request)` - Set spending limits
- `getAccount(address)` - Get account details
- `getAccountBalances(address)` - Get account balances
- `generateSessionSecrets()` - Generate keypairs for all supported providers
